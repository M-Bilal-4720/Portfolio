trigger:
  - main

variables:
  DEPLOY_PATH: "/var/www/your_domain"  # Destination on the laptop

stages:
  - stage: DeployToLaptop
    jobs:
      - job: deploy
        displayName: "üöÄ Deploy HTML/PHP Site to Laptop"
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self

          # Optional: download private SSH key from secure files
          - task: DownloadSecureFile@1
            name: GetSSHKey
            inputs:
              secureFile: laptop-dev.pem  # Must be uploaded in Azure DevOps Library > Secure Files

          - script: |
              echo "Setting SSH permissions..."
              chmod 600 $(GetSSHKey.secureFilePath)
              echo "Host laptop" >> ~/.ssh/config
              echo "  HostName $(LAPTOP_HOST)" >> ~/.ssh/config
              echo "  User $(LAPTOP_USER)" >> ~/.ssh/config
              echo "  IdentityFile $(GetSSHKey.secureFilePath)" >> ~/.ssh/config
              echo "  StrictHostKeyChecking no" >> ~/.ssh/config
            displayName: "üîê Setup SSH Config"

          - task: ArchiveFiles@2
            displayName: "üì¶ Archive Site Files"
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/site.zip'
              replaceExistingArchive: true

          - task: PublishPipelineArtifact@1
            displayName: "‚¨ÜÔ∏è Publish Site Artifact"
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/site.zip'
              artifact: drop

          - task: DownloadPipelineArtifact@2
            displayName: "‚¨áÔ∏è Download Artifact for Deployment"
            inputs:
              artifact: drop
              path: '$(Pipeline.Workspace)/drop'

          - script: |
              echo "Copying files to laptop..."
              scp -i $(GetSSHKey.secureFilePath) -o StrictHostKeyChecking=no \
              $(Pipeline.Workspace)/drop/site.zip \
              $(LAPTOP_USER)@$(LAPTOP_HOST):$(DEPLOY_PATH)/
            displayName: "üì§ SCP to Laptop"

          - script: |
              echo "Unzipping and restarting nginx..."
              ssh -i $(GetSSHKey.secureFilePath) -o StrictHostKeyChecking=no \
              $(LAPTOP_USER)@$(LAPTOP_HOST) << 'EOF'
                cd $(DEPLOY_PATH)
                unzip -o site.zip
                sudo systemctl reload nginx
              EOF
            displayName: "üîß Remote Unzip + Reload NGINX"
