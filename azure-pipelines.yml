trigger:
  - main

variables:
  DEPLOY_PATH: "/var/www/your_domain"

stages:
  - stage: DeployToLaptop
    jobs:
      - job: deploy
        displayName: "Deploy HTML/PHP Site to Laptop"
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self

          - task: ArchiveFiles@2
            displayName: "üì¶ Archive Site"
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/site.zip'
              replaceExistingArchive: true

          - task: PublishPipelineArtifact@1
            displayName: "‚¨ÜÔ∏è Publish Artifact"
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/site.zip'
              artifact: drop

          - task: DownloadPipelineArtifact@2
            displayName: "‚¨áÔ∏è Download Artifact"
            inputs:
              artifact: drop
              path: '$(Pipeline.Workspace)/drop'

          - task: CopyFilesOverSSH@0
            displayName: "üöÄ Copy to Laptop"
            inputs:
              sshEndpoint: 'LaptopSSH'
              sourceFolder: '$(Pipeline.Workspace)/drop'
              contents: '**'
              targetFolder: '$(DEPLOY_PATH)'

          - task: SSH@0
            displayName: "üìÇ Extract and Reload"
            inputs:
              sshEndpoint: 'LaptopSSH'
              runOptions: 'commands'
              commands: |
                cd $(DEPLOY_PATH)
                unzip -o site.zip
                sudo systemctl reload nginx || true
